<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>Place Order - Inventory Pro</title>
    <script>
        (function() {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <style>
        :root { --card-bg: #ffffff; --text-main: #2d3748; --border-color: #eee; --page-bg: #f8fafc; }
        .dark-mode { --card-bg: #1e293b; --text-main: #f8fafc; --border-color: #334155; --page-bg: #0f172a; }

        body { background-color: var(--page-bg); color: var(--text-main); margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        .full-width-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }

        .order-header-box {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .search-input {
            background: var(--page-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 12px 20px;
            border-radius: 12px;
            width: 300px;
        }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .product-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .price-tag { color: #4361ee; font-weight: 800; font-size: 1.5rem; margin: 15px 0; }
        
        /* Added Peso sign before the price tag via CSS or keep in template literal */
        .price-tag::before { content: "‚Ç±"; margin-right: 2px; }

        .btn-add-item.active { background: #10b981; }

        #receiptArea { display: none; }
        @media print {
            body * { visibility: hidden; }
            #receiptArea, #receiptArea * { visibility: visible; }
            #receiptArea { display: block; position: absolute; left: 0; top: 0; width: 100%; color: black !important; }
        }

    .product-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-radius: 12px;
        margin-bottom: 15px;
        background: #f1f5f9;
    }
    .product-card {
        transition: transform 0.2s;
    }
    .product-card:hover {
        transform: translateY(-5px);
    }
    </style>
</head>
<body>
    <div class="full-width-container">
        <header class="order-header-box">
            <div class="header-left">
                <a href="landing-page.html" class="clear-btn" style="text-decoration: none; padding: 10px 15px;">‚Üê Back</a>
                <input type="text" id="searchInput" class="search-input" placeholder="Search items..." onkeyup="filterProducts()">
                <h1 style="margin: 0; font-size: 1.5rem;">üõí New Order</h1>
            </div>
            <div style="text-align: right;">
                <div id="orderTotalDisplay" style="font-size: 1.4rem; font-weight: 800; margin-bottom: 5px;">Total: ‚Ç±0.00</div>
                <button class="add-main-btn" onclick="openCartReview()">Review Order</button>
            </div>
        </header>

        <div id="productContainer" class="product-grid"></div>
    </div>

    <div id="receiptArea">
        <h1>Order Receipt</h1>
        <p id="receiptDate"></p>
        <hr>
        <table style="width: 100%; border-collapse: collapse;">
            <thead><tr style="text-align: left;"><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
            <tbody id="receiptItems"></tbody>
        </table>
        <h2 id="receiptTotal" style="text-align: right;"></h2>
    </div>

    <div id="cartModal" class="modal" style="display: none;">
        <div class="modal-content" style="background: var(--card-bg);">
            <header class="modal-header">
                <h2>Confirm Purchase</h2>
                <span class="close-btn" onclick="closeCartModal()">&times;</span>
            </header>
            <div style="padding: 20px;">
                <table style="width: 100%; color: var(--text-main); margin-bottom: 20px;">
                    <tbody id="cartItemsList"></tbody>
                </table>
                <div style="text-align: right;">
                    <h3 id="modalTotal"></h3>
                    <button class="clear-btn" onclick="closeCartModal()">Cancel</button>
                    <button class="add-main-btn" onclick="confirmFinalOrder()">Place Order & Get PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allProducts = [];
        let basket = {};

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                allProducts = await response.json();
                renderProducts(allProducts);
            } catch (err) { console.error("Error loading products:", err); }
        }

        function renderProducts(productsToRender) {
            const container = document.getElementById('productContainer');
            container.innerHTML = productsToRender.map(prod => `
                <div class="product-card">
                    <div>
                        <img src="${prod.image_url || 'https://via.placeholder.com/300x180?text=No+Image'}" 
                            alt="${prod.name}" 
                            class="product-image">
                        
                        <h3>${prod.name}</h3>
                        <span style="color: #94a3b8;">üì¶ Stock: ${prod.quantity}</span>
                        <div class="price-tag">${parseFloat(prod.price).toFixed(2)}</div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="number" class="order-input" id="qty-${prod.id}" value="1" min="1" max="${prod.quantity}" style="width: 60px;">
                        <button class="btn-add-item" id="btn-${prod.id}" onclick="updateBasket(${prod.id})">Add</button>
                    </div>
                </div>
            `).join('');
        }

        function filterProducts() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term));
            renderProducts(filtered);
        }

        function updateBasket(id) {
            const qty = parseInt(document.getElementById(`qty-${id}`).value);
            const product = allProducts.find(p => p.id === id);
            if (qty > 0 && qty <= product.quantity) {
                basket[id] = qty;
                const btn = document.getElementById(`btn-${id}`);
                btn.innerText = "‚úì Added";
                btn.classList.add('active');
                calculateTotal();
            } else { alert("Insufficient stock!"); }
        }

        function calculateTotal() {
            let total = 0;
            Object.keys(basket).forEach(id => {
                const p = allProducts.find(prod => prod.id == id);
                total += p.price * basket[id];
            });
            document.getElementById('orderTotalDisplay').innerText = `Total: ‚Ç±${total.toFixed(2)}`;
        }

        function openCartReview() {
            if (Object.keys(basket).length === 0) return alert("Your cart is empty!");
            const list = document.getElementById('cartItemsList');
            let total = 0;
            list.innerHTML = Object.keys(basket).map(id => {
                const p = allProducts.find(prod => prod.id == id);
                total += p.price * basket[id];
                return `<tr style="border-bottom: 1px solid var(--border-color);"><td style="padding: 10px;">${p.name}</td><td>x${basket[id]}</td><td style="text-align: right;">‚Ç±${(p.price * basket[id]).toFixed(2)}</td></tr>`;
            }).join('');
            document.getElementById('modalTotal').innerText = `Total: ‚Ç±${total.toFixed(2)}`;
            document.getElementById('cartModal').style.display = 'flex';
        }

        function closeCartModal() { document.getElementById('cartModal').style.display = 'none'; }

        async function confirmFinalOrder() {
            const orderItems = Object.keys(basket).map(id => ({ productId: parseInt(id), quantity: basket[id] }));
            
            try {
                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: orderItems })
                });

                const result = await response.json();

                if (result.success) {
                    prepareReceipt();
                    window.print(); 
                    alert("Order processed successfully!");
                    window.location.reload();
                } else {
                    alert("Order Error: " + result.error);
                }
            } catch (err) { 
                alert("Network Error: Could not reach the server.");
            }
        }

        function prepareReceipt() {
            document.getElementById('receiptDate').innerText = "Date: " + new Date().toLocaleString();
            let total = 0;
            document.getElementById('receiptItems').innerHTML = Object.keys(basket).map(id => {
                const p = allProducts.find(prod => prod.id == id);
                total += p.price * basket[id];
                return `<tr><td>${p.name}</td><td>${basket[id]}</td><td>‚Ç±${(p.price * basket[id]).toFixed(2)}</td></tr>`;
            }).join('');
            document.getElementById('receiptTotal').innerText = `Grand Total: ‚Ç±${total.toFixed(2)}`;
        }

        loadProducts();
    </script>
</body>
</html>