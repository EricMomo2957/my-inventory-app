<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clerk Dashboard | Inventory Pro</title>
    
    <script>
        // AUTH & ROLE GUARD
        (function() {
            const userStr = localStorage.getItem('currentUser');
            if (!userStr) { window.location.href = 'login.html'; return; }
            const user = JSON.parse(userStr);
            if (user.role !== 'clerk' && user.role !== 'admin') {
                window.location.href = 'user_dashboard.html'; 
                return;
            }
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-light: #0ea5e915;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --sidebar-width: 260px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        .dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; }
        body { margin: 0; display: flex; background: var(--bg-color); color: var(--text-main); font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; transition: background 0.3s; }

        .sidebar { width: var(--sidebar-width); background: var(--card-bg); border-right: 1px solid var(--border-color); padding: 24px; display: flex; flex-direction: column; position: fixed; height: 100vh; }
        .logo { font-size: 1.25rem; font-weight: 800; color: var(--primary); margin-bottom: 40px; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; text-decoration: none; color: var(--text-muted); border-radius: 10px; font-weight: 600; margin-bottom: 8px; transition: 0.2s; }
        .nav-link.active { background: var(--primary); color: white; }
        .nav-link:hover:not(.active) { background: var(--primary-light); color: var(--primary); }

        .main-content { margin-left: var(--sidebar-width); flex-grow: 1; padding: 40px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .stat-card h4 { margin: 0; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card p { margin: 10px 0 0 0; font-size: 1.75rem; font-weight: 800; }

        .inventory-card { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border-color); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg-color); text-align: left; padding: 16px; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; border-bottom: 1px solid var(--border-color); }
        td { padding: 16px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .product-img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; background: #eee; }
        .product-info { display: flex; align-items: center; gap: 12px; }

        .status-pill { padding: 6px 12px; border-radius: 20px; font-size: 0.65rem; font-weight: 800; }
        .status-low { background: #fee2e2; color: var(--danger); }
        .status-ok { background: #dcfce7; color: var(--success); }
        
        .btn-update { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .btn-update:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .search-bar { width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); margin-bottom: 20px; font-family: inherit; }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; align-items: center;
            justify-content: center; z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--card-bg); width: 100%; max-width: 480px;
            padding: 30px; border-radius: 20px; box-shadow: var(--shadow);
            position: relative; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; }
        .modal-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); font-weight: 600; font-family: inherit; }
        
        .modal-footer { display: flex; gap: 12px; margin-top: 30px; }
        .btn-cancel { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: none; color: var(--text-muted); cursor: pointer; font-weight: 700; }
        .btn-save { flex: 2; padding: 12px; border-radius: 10px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: 700; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <a href="#" class="logo">
            <div style="width: 32px; height: 32px; background: var(--primary); border-radius: 8px;"></div>
            <span>Inventory Pro</span>
        </a>
        <nav style="flex-grow: 1;">
            <a href="#" class="nav-link active"><span>üìä</span> <span>Stock Control</span></a>
            <a href="faq-admin.html" class="nav-link"><span>‚ùì</span> <span>FAQ Editor</span></a>
            <a href="user_setting.html" class="nav-link"><span>‚öôÔ∏è</span> <span>Settings</span></a>
        </nav>
        <button onclick="logout()" class="nav-link" style="background:none; border:none; width:100%; color: var(--danger); margin-top: auto; cursor:pointer;">
            <span>üö™</span> <span>Logout</span>
        </button>
    </aside>

    <main class="main-content">
        <header style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
            <div>
                <h1 style="margin:0; font-weight: 800;">Clerk Stock Portal</h1>
                <p style="color: var(--text-muted); margin-top: 5px;" id="currentDate">Live database control</p>
            </div>
            <button onclick="exportToCSV()" style="padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); cursor:pointer; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                üì• Export CSV
            </button>
        </header>

        <div class="stats-grid">
            <div class="stat-card"><h4>Total Products</h4><p id="totalItems">0</p></div>
            <div class="stat-card"><h4>Low Stock Alerts</h4><p id="lowStockCount" style="color: var(--danger);">0</p></div>
            <div class="stat-card"><h4>Inventory Value</h4><p id="totalValue">‚Ç±0.00</p></div>
        </div>

        <input type="text" id="clerkSearch" class="search-bar" placeholder="Filter by product name or category..." onkeyup="renderInventory()">

        <div class="inventory-card">
            <table>
                <thead>
                    <tr>
                        <th>Product Details</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Current Stock</th>
                        <th>Status</th>
                        <th style="text-align: right;">Action</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>

        <div style="margin-top: 40px; margin-bottom: 15px;">
            <h2 style="margin:0; font-weight: 800; font-size: 1.25rem;">Recent Stock Activity</h2>
        </div>
        <div class="inventory-card">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Clerk</th>
                        <th>Product</th>
                        <th>Adjustment</th>
                        <th>Stock Flow</th>
                    </tr>
                </thead>
                <tbody id="logBody"></tbody>
            </table>
        </div>
    </main>

    <div id="adjustmentModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalProductName">Adjust Stock</h2>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin-top:5px;" id="modalProductId"></p>
            </div>
            
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" id="editName" class="modal-input">
            </div>

            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Category</label>
                    <input type="text" id="editCategory" class="modal-input">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Price (‚Ç±)</label>
                    <input type="number" step="0.01" id="editPrice" class="modal-input">
                </div>
            </div>

            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Current Stock</label>
                    <input type="text" id="currentStockDisplay" class="modal-input" disabled style="opacity: 0.6;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Adjustment (+/-)</label>
                    <input type="number" id="modalAdjustment" class="modal-input" placeholder="e.g. 10 or -5">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-save" id="saveButton">Apply Changes</button>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        const lowStockThreshold = parseInt(localStorage.getItem('lowStockThreshold')) || 10;
        document.getElementById('currentDate').innerText = `Live database control: ${new Date().toLocaleDateString()}`;

        async function loadInventory() {
            try {
                const res = await fetch('http://localhost:3000/api/products');
                products = await res.json();
                renderInventory();
            } catch (err) { console.error("Load failed:", err); }
        }

        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            const search = document.getElementById('clerkSearch').value.toLowerCase();
            
            let lowCount = 0;
            let totalVal = 0;

            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(search) || 
                p.category.toLowerCase().includes(search)
            );

            tbody.innerHTML = filtered.map(p => {
                const isLow = p.quantity <= lowStockThreshold;
                if(isLow) lowCount++;
                totalVal += (p.price * p.quantity);

                return `
                    <tr>
                        <td>
                            <div class="product-info">
                                <img src="${p.image_url}" class="product-img" onerror="this.src='https://via.placeholder.com/40?text=P'">
                                <div>
                                    <div style="font-weight:700;">${p.name}</div>
                                    <div style="font-size:0.7rem; color:var(--text-muted)">ID: #${p.id}</div>
                                </div>
                            </div>
                        </td>
                        <td><span style="font-weight:600;">${p.category}</span></td>
                        <td>‚Ç±${parseFloat(p.price).toLocaleString()}</td>
                        <td style="font-weight:800; font-size: 1.1rem;">${p.quantity}</td>
                        <td><span class="status-pill ${isLow ? 'status-low' : 'status-ok'}">${isLow ? '‚ö†Ô∏è LOW' : '‚úÖ OK'}</span></td>
                        <td style="text-align: right;">
                            <button class="btn-update" onclick="openAdjustmentModal(${p.id})">Update</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('totalItems').innerText = products.length;
            document.getElementById('lowStockCount').innerText = lowCount;
            document.getElementById('totalValue').innerText = `‚Ç±${totalVal.toLocaleString()}`;
        }

        function openAdjustmentModal(id) {
            const product = products.find(p => p.id === id);
            document.getElementById('modalProductName').innerText = "Adjust: " + product.name;
            document.getElementById('modalProductId').innerText = "System ID: #" + product.id;
            
            document.getElementById('editName').value = product.name;
            document.getElementById('editCategory').value = product.category || "General";
            document.getElementById('editPrice').value = product.price;
            document.getElementById('currentStockDisplay').value = product.quantity;
            document.getElementById('modalAdjustment').value = "";
            
            document.getElementById('saveButton').onclick = () => applyAdjustment(id);
            document.getElementById('adjustmentModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('adjustmentModal').style.display = 'none';
        }

        async function applyAdjustment(id) {
            const newName = document.getElementById('editName').value;
            const newCategory = document.getElementById('editCategory').value;
            const newPrice = parseFloat(document.getElementById('editPrice').value);
            const adjValue = parseInt(document.getElementById('modalAdjustment').value) || 0;
            
            const user = JSON.parse(localStorage.getItem('currentUser')) || { full_name: "Clerk" };
            const product = products.find(p => p.id === id);
            const newQuantity = Math.max(0, product.quantity + adjValue);

            try {
                const response = await fetch(`http://localhost:3000/api/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName,
                        category: newCategory,
                        price: newPrice,
                        quantity: newQuantity,
                        adjustment: adjValue,
                        clerk_name: user.full_name
                    })
                });

                if (response.ok) {
                    closeModal();
                    await loadInventory();
                    await loadLogs();
                } else {
                    alert("Failed to update product details.");
                }
            } catch (err) { alert("Server connection error."); }
        }

        async function loadLogs() {
            try {
                const res = await fetch('http://localhost:3000/api/logs');
                const logs = await res.json();
                document.getElementById('logBody').innerHTML = logs.map(log => {
                    const date = new Date(log.created_at).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const isPositive = log.adjustment >= 0;
                    return `
                        <tr>
                            <td style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">${date}</td>
                            <td><strong>${log.clerk_name}</strong></td>
                            <td><span style="font-weight:600;">${log.product_name}</span></td>
                            <td><span style="color: ${isPositive ? 'var(--success)' : 'var(--danger)'}; font-weight: 800;">
                                ${isPositive ? '+' : ''}${log.adjustment}
                            </span></td>
                            <td style="color: var(--text-muted); font-size: 0.85rem;">
                                ${log.old_quantity} ‚Üí <strong>${log.new_quantity}</strong>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) { console.error("Log load failed:", err); }
        }

        function exportToCSV() {
            const headers = ["ID", "Name", "Category", "Price", "Quantity"];
            const rows = products.map(p => [p.id, `"${p.name}"`, p.category, p.price, p.quantity]);
            const csvContent = [headers, ...rows].map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Inventory_Report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function logout() { 
            localStorage.removeItem('currentUser'); 
            window.location.href = 'login.html'; 
        }

        (async function init() {
            await loadInventory();
            await loadLogs();
        })();
    </script>
</body>
</html>