<nav class="sidenav">
    <div class="nav-header">
        <h2>Inventory Manager</h2>
    </div>

    <div class="nav-profile">
        <div class="profile-info">
            <span id="sideNavName">User Name</span>
            <small id="sideNavRole">Clerk</small>
        </div>
    </div>

    <div class="nav-links">
        <p class="section-title">Main Menu</p>
        <a href="index.html" class="nav-item">üè† Dashboard</a>
        <a href="customer-orders.html" class="nav-item">üõí Customer Orders</a> 
        <a href="calendar.html" class="nav-item">üìÖ Calendar</a>
        <a href="faq.html" class="nav-item">‚ùì FAQ</a>
        <p class="section-title">User Account</p>
        <a href="profile.html" class="nav-item">üë§ Profile</a>
        <a href="settings.html" class="nav-item">‚öôÔ∏è Settings</a>
        <a href="admin_management.html" class="nav-item admin-link" style="color: #ff9f43; display: none;">üõ°Ô∏è Admin Management</a>
    </div>

    <div class="nav-footer">
        <button class="nav-btn logout-btn" onclick="logout()">üö™ Logout</button>
    </div>
</nav>

<style>
    /* Theme Variables */
    :root {
        --side-bg: #ffffff;
        --side-text: #333333;
        --side-hover: #f0f2f5;
        --side-profile-bg: rgba(0, 0, 0, 0.05);
        --side-border: #eeeeee;
        --text-main: #333333;
        --text-muted: #64748b;
    }

    /* Dark Mode Variables */
    .dark-mode {
        --side-bg: #1e293b;
        --side-text: #f8fafc;
        --side-hover: rgba(255, 255, 255, 0.1);
        --side-profile-bg: rgba(255, 255, 255, 0.08);
        --side-border: #334155;
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
    }

    .sidenav {
        width: 260px;
        height: 100vh;
        background: var(--side-bg);
        color: var(--side-text);
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--side-border);
        transition: background 0.3s, color 0.3s;
    }

    .nav-header { padding: 20px; text-align: center; border-bottom: 1px solid var(--side-border); }
    .nav-header h2 { font-size: 1.2rem; margin: 0; color: #4361ee; }

    .nav-profile {
        display: flex;
        align-items: center;
        padding: 15px;
        margin: 15px;
        background: var(--side-profile-bg);
        border-radius: 12px;
        gap: 12px;
    }

    .side-avatar-wrapper { width: 45px; height: 45px; flex-shrink: 0; }
    #sideNavAvatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #4361ee; }

    .profile-info { display: flex; flex-direction: column; overflow: hidden; }
    #sideNavName { font-weight: 600; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #sideNavRole { font-size: 0.75rem; color: var(--text-muted); text-transform: capitalize; }

    .nav-links { flex-grow: 1; overflow-y: auto; }
    .section-title { font-size: 0.7rem; text-transform: uppercase; margin: 20px 20px 10px; opacity: 0.6; color: var(--text-muted); }

    .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        text-decoration: none;
        color: var(--text-main);
        transition: 0.2s;
        gap: 10px;
        font-size: 0.95rem;
    }

    .nav-item:hover { background: var(--side-hover); }

    .nav-footer { padding: 15px; border-top: 1px solid var(--side-border); display: flex; flex-direction: column; gap: 10px; }
    .nav-btn {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: var(--side-profile-bg);
        color: var(--text-main);
        font-weight: 500;
        transition: 0.2s;
        text-align: left;
    }
    .nav-btn:hover { background: var(--side-hover); }
    .logout-btn { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
</style>

<script>
    /**
     * DARK MODE LOGIC
     */
    function toggleDarkMode() {
        const isDark = document.documentElement.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        updateThemeButton(isDark);
    }

    function updateThemeButton(isDark) {
        const btn = document.getElementById('themeToggle');
        if (btn) {
            btn.innerHTML = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        }
    }

    /**
     * LIVE UI SYNC LOGIC
     */
    async function syncSidebarUI() {
        // 1. Get cached info for immediate display
        let user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        // Apply local storage data immediately so the UI doesn't look empty
        updateDisplay(user);

        // 2. Fetch LATEST data from server to catch recent profile changes
        try {
            const response = await fetch(`/api/user/profile?id=${user.id}`);
            if (response.ok) {
                const latestUser = await response.json();
                // Merge data and update storage
                user = { ...user, ...latestUser };
                localStorage.setItem('currentUser', JSON.stringify(user));
                // Update UI again with fresh data
                updateDisplay(user);
            }
        } catch (err) {
            console.error("Failed to fetch latest profile data", err);
        }

        // 3. Handle Theme preference
        const darkMode = localStorage.getItem('darkMode');
        if (darkMode === 'enabled') {
            document.documentElement.classList.add('dark-mode');
            updateThemeButton(true);
        }
    }

    function updateDisplay(user) {
        // Update Name and Role
        const nameEl = document.getElementById('sideNavName');
        const roleEl = document.getElementById('sideNavRole');
        if(nameEl) nameEl.innerText = user.full_name || user.username;
        if(roleEl) roleEl.innerText = user.role || 'clerk';

        // Update Avatar with Cache Busting
        const sideAvatar = document.getElementById('sideNavAvatar');
        if (sideAvatar && user.profile_image && user.profile_image !== "NULL") {
            const timestamp = new Date().getTime();
            // Check if profile_image is a full URL or relative path
            const imageSrc = user.profile_image.startsWith('http') ? user.profile_image : user.profile_image;
            sideAvatar.src = `${imageSrc}?t=${timestamp}`;
        }

        // Role-based Access
        const adminLink = document.querySelector('.admin-link');
        if (adminLink) {
            adminLink.style.display = (user.role === 'admin') ? 'block' : 'none';
        }
    }

    function logout() {
        localStorage.clear(); // Clears everything including theme/user
        window.location.href = 'login.html';
    }

    // Run when the DOM is ready
    document.addEventListener('DOMContentLoaded', syncSidebarUI);
</script>