<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clerk Dashboard | Inventory Pro</title>
    
    <script>
        // AUTH & ROLE GUARD
        (function() {
            const userStr = localStorage.getItem('currentUser');
            if (!userStr) { window.location.href = 'login.html'; return; }
            const user = JSON.parse(userStr);
            if (user.role !== 'clerk' && user.role !== 'admin') {
                window.location.href = 'user_dashboard.html'; 
                return;
            }
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-light: #0ea5e915;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --sidebar-width: 260px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        .dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; }
        body { margin: 0; display: flex; background: var(--bg-color); color: var(--text-main); font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; transition: background 0.3s; }

        /* Sidebar & Navigation */
        .sidebar { width: var(--sidebar-width); background: var(--card-bg); border-right: 1px solid var(--border-color); padding: 24px; display: flex; flex-direction: column; position: fixed; height: 100vh; }
        .logo { font-size: 1.25rem; font-weight: 800; color: var(--primary); margin-bottom: 40px; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; text-decoration: none; color: var(--text-muted); border-radius: 10px; font-weight: 600; margin-bottom: 8px; transition: 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; font-family: inherit; }
        .nav-link.active { background: var(--primary); color: white; }
        .nav-link:hover:not(.active) { background: var(--primary-light); color: var(--primary); }

        .main-content { margin-left: var(--sidebar-width); flex-grow: 1; padding: 40px; }
        .content-view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .content-view.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Tables & Cards */
        .inventory-card, .settings-card { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border-color); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 30px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg-color); text-align: left; padding: 16px; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; border-bottom: 1px solid var(--border-color); }
        td { padding: 16px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .stat-card h4 { margin: 0; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card p { margin: 10px 0 0 0; font-size: 1.75rem; font-weight: 800; }

        /* Forms & Modals */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; }
        .modal-input, .settings-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); font-weight: 600; font-family: inherit; }
        
        .btn-update, .btn-save { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .btn-update:hover { filter: brightness(1.1); transform: translateY(-1px); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; align-items: center;
            justify-content: center; z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 480px; padding: 30px; border-radius: 20px; box-shadow: var(--shadow); position: relative; }

        .status-pill { padding: 6px 12px; border-radius: 20px; font-size: 0.65rem; font-weight: 800; }
        .status-low { background: #fee2e2; color: var(--danger); }
        .status-ok { background: #dcfce7; color: var(--success); }

        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 800; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <a href="#" class="logo">
            <div style="width: 32px; height: 32px; background: var(--primary); border-radius: 8px;"></div>
            <span>Inventory Pro</span>
        </a>
        <nav style="flex-grow: 1;">
            <button onclick="switchView('stock-view')" class="nav-link active" id="nav-stock"><span>üìä</span> <span>Stock Control</span></button>
            <button onclick="switchView('profile-view')" class="nav-link" id="nav-profile"><span>üë§</span> <span>Profile</span></button>
            <button onclick="switchView('settings-view')" class="nav-link" id="nav-settings"><span>‚öôÔ∏è</span> <span>Settings</span></button>
        </nav>
        <button onclick="logout()" class="nav-link" style="color: var(--danger); margin-top: auto;">
            <span>üö™</span> <span>Logout</span>
        </button>
    </aside>

    <main class="main-content">
        
        <div id="stock-view" class="content-view active">
            <header style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
                <div>
                    <h1 style="margin:0; font-weight: 800;">Clerk Stock Portal</h1>
                    <p style="color: var(--text-muted); margin-top: 5px;" id="currentDate">Live database control</p>
                </div>
                <button onclick="exportToCSV()" style="padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); cursor:pointer; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                    üì• Export CSV
                </button>
            </header>

            <div class="stats-grid">
                <div class="stat-card"><h4>Total Products</h4><p id="totalItems">0</p></div>
                <div class="stat-card"><h4>Low Stock Alerts</h4><p id="lowStockCount" style="color: var(--danger);">0</p></div>
                <div class="stat-card"><h4>Inventory Value</h4><p id="totalValue">‚Ç±0.00</p></div>
            </div>

            <input type="text" id="clerkSearch" class="search-bar" style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main); margin-bottom: 20px;" placeholder="Filter by product name..." onkeyup="renderInventory()">

            <div class="inventory-card" style="padding: 0;">
                <table>
                    <thead>
                        <tr>
                            <th>Product Details</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th style="text-align: right;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody"></tbody>
                </table>
            </div>

            <h2 style="margin: 40px 0 15px 0; font-weight: 800; font-size: 1.25rem;">Recent Activity</h2>
            <div class="inventory-card" style="padding: 0;">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Clerk</th>
                            <th>Product</th>
                            <th>Adjustment</th>
                            <th>Flow</th>
                        </tr>
                    </thead>
                    <tbody id="logBody"></tbody>
                </table>
            </div>
        </div>

        <div id="profile-view" class="content-view">
            <h1 style="font-weight: 800; margin-bottom: 30px;">Account Profile</h1>
            <div class="settings-card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileInitials">JD</div>
                    <div>
                        <h2 id="displayFullName" style="margin:0;">John Doe</h2>
                        <p id="displayRole" style="color: var(--primary); font-weight: 700; text-transform: uppercase; font-size: 0.8rem; margin-top: 5px;">Clerk</p>
                    </div>
                </div>
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="profileName" class="settings-input">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="profileUser" class="settings-input" disabled style="opacity: 0.6;">
                </div>
                <button class="btn-save" onclick="updateProfile()">Save Profile Changes</button>
            </div>
        </div>

        <div id="settings-view" class="content-view">
            <h1 style="font-weight: 800; margin-bottom: 30px;">Dashboard Settings</h1>
            <div class="settings-card">
                <h3 style="margin-top:0;">Display Preferences</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <div style="font-weight: 700;">Dark Mode</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Adjust the interface for low-light environments</div>
                    </div>
                    <button class="btn-update" id="darkModeToggle" onclick="toggleDarkMode()">Toggle Mode</button>
                </div>
                
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                
                <h3>Inventory Alerts</h3>
                <div class="form-group">
                    <label>Low Stock Threshold</label>
                    <input type="number" id="thresholdInput" class="settings-input" placeholder="Currently: 10">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">Products with quantity equal to or below this number will show a warning.</p>
                </div>
                <button class="btn-save" onclick="saveSettings()">Save Preferences</button>
            </div>
        </div>

    </main>

    <div id="adjustmentModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalProductName">Adjust Stock</h2>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin-top:5px;" id="modalProductId"></p>
            </div>
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" id="editName" class="modal-input">
            </div>
            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Category</label>
                    <input type="text" id="editCategory" class="modal-input">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Price (‚Ç±)</label>
                    <input type="number" step="0.01" id="editPrice" class="modal-input">
                </div>
            </div>
            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Current Stock</label>
                    <input type="text" id="currentStockDisplay" class="modal-input" disabled style="opacity: 0.6;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Adjustment (+/-)</label>
                    <input type="number" id="modalAdjustment" class="modal-input" placeholder="e.g. 10 or -5">
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; margin-top: 30px;">
                <button class="btn-cancel" onclick="closeModal()" style="flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: none; color: var(--text-muted); cursor: pointer; font-weight: 700;">Cancel</button>
                <button class="btn-save" id="saveButton" style="flex: 2;">Apply Changes</button>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let lowStockThreshold = parseInt(localStorage.getItem('lowStockThreshold')) || 10;

        function switchView(viewId) {
            // Toggle Views
            document.querySelectorAll('.content-view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // Update Sidebar Active State
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            if (viewId === 'stock-view') document.getElementById('nav-stock').classList.add('active');
            if (viewId === 'profile-view') document.getElementById('nav-profile').classList.add('active');
            if (viewId === 'settings-view') document.getElementById('nav-settings').classList.add('active');
        }

        // Profile Logic
        function loadProfile() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user) {
                document.getElementById('displayFullName').innerText = user.full_name;
                document.getElementById('displayRole').innerText = user.role;
                document.getElementById('profileName').value = user.full_name;
                document.getElementById('profileUser').value = user.username;
                document.getElementById('profileInitials').innerText = user.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
            }
        }

        function updateProfile() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            user.full_name = document.getElementById('profileName').value;
            localStorage.setItem('currentUser', JSON.stringify(user));
            loadProfile();
            alert("Profile updated locally!");
        }

        // Settings Logic
        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        }

        function saveSettings() {
            const val = document.getElementById('thresholdInput').value;
            if (val) {
                localStorage.setItem('lowStockThreshold', val);
                lowStockThreshold = parseInt(val);
                renderInventory();
                alert("Settings saved!");
            }
        }

        // Stock Logic (from your previous code)
        async function loadInventory() {
            try {
                const res = await fetch('http://localhost:3000/api/products');
                products = await res.json();
                renderInventory();
            } catch (err) { console.error("Load failed:", err); }
        }

        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            const search = document.getElementById('clerkSearch').value.toLowerCase();
            let lowCount = 0; let totalVal = 0;

            const filtered = products.filter(p => p.name.toLowerCase().includes(search));

            tbody.innerHTML = filtered.map(p => {
                const isLow = p.quantity <= lowStockThreshold;
                if(isLow) lowCount++;
                totalVal += (p.price * p.quantity);
                return `
                    <tr>
                        <td><strong>${p.name}</strong><br><small style="color:var(--text-muted)">ID: #${p.id}</small></td>
                        <td>${p.category}</td>
                        <td>‚Ç±${parseFloat(p.price).toLocaleString()}</td>
                        <td>${p.quantity}</td>
                        <td><span class="status-pill ${isLow ? 'status-low' : 'status-ok'}">${isLow ? 'LOW' : 'OK'}</span></td>
                        <td style="text-align: right;"><button class="btn-update" onclick="openAdjustmentModal(${p.id})">Update</button></td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('totalItems').innerText = products.length;
            document.getElementById('lowStockCount').innerText = lowCount;
            document.getElementById('totalValue').innerText = `‚Ç±${totalVal.toLocaleString()}`;
        }

        function openAdjustmentModal(id) {
            const product = products.find(p => p.id === id);
            document.getElementById('modalProductName').innerText = "Adjust: " + product.name;
            document.getElementById('modalProductId').innerText = "System ID: #" + product.id;
            document.getElementById('editName').value = product.name;
            document.getElementById('editCategory').value = product.category || "General";
            document.getElementById('editPrice').value = product.price;
            document.getElementById('currentStockDisplay').value = product.quantity;
            document.getElementById('saveButton').onclick = () => applyAdjustment(id);
            document.getElementById('adjustmentModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('adjustmentModal').style.display = 'none'; }

        async function applyAdjustment(id) {
            const newName = document.getElementById('editName').value;
            const newCategory = document.getElementById('editCategory').value;
            const newPrice = parseFloat(document.getElementById('editPrice').value);
            const adjValue = parseInt(document.getElementById('modalAdjustment').value) || 0;
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const product = products.find(p => p.id === id);

            try {
                await fetch(`http://localhost:3000/api/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName, category: newCategory, price: newPrice,
                        quantity: Math.max(0, product.quantity + adjValue),
                        adjustment: adjValue, clerk_name: user.full_name
                    })
                });
                closeModal(); await loadInventory(); await loadLogs();
            } catch (err) { alert("Error updating database."); }
        }

        async function loadLogs() {
            try {
                const res = await fetch('http://localhost:3000/api/logs');
                const logs = await res.json();
                document.getElementById('logBody').innerHTML = logs.slice(0, 10).map(log => `
                    <tr>
                        <td style="font-size:0.8rem">${new Date(log.created_at).toLocaleDateString()}</td>
                        <td>${log.clerk_name}</td>
                        <td>${log.product_name}</td>
                        <td style="color:${log.adjustment >= 0 ? 'var(--success)' : 'var(--danger)'}">${log.adjustment >= 0 ? '+' : ''}${log.adjustment}</td>
                        <td>${log.old_quantity} ‚Üí ${log.new_quantity}</td>
                    </tr>
                `).join('');
            } catch (err) { }
        }

        function logout() { localStorage.removeItem('currentUser'); window.location.href = 'login.html'; }

        (async function init() {
            document.getElementById('currentDate').innerText = `Live database control: ${new Date().toLocaleDateString()}`;
            loadProfile();
            await loadInventory();
            await loadLogs();
        })();
    </script>
</body>
</html>